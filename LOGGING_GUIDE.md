# CCTV视频下载器 - 日志系统使用指南

## 概述

本项目已经集成了完整的日志系统，所有 `qDebug()`、`qWarning()`、`qCritical()` 等Qt日志输出都会自动写入日志文件和控制台。

## 日志文件位置

- **日志文件**: `cctvvideodownloader.log` (位于应用程序同级目录)
- **格式**: 包含时间戳、日志级别和消息内容

## 日志级别说明

| 级别 | Qt函数 | 用途 |
|------|--------|------|
| DEBUG | `qDebug()` | 详细的调试信息，操作流程跟踪 |
| INFO | `qInfo()` | 一般信息，程序运行状态 |
| WARNING | `qWarning()` | 警告信息，不影响程序运行的问题 |
| CRITICAL | `qCritical()` | 严重错误，可能导致功能异常 |
| FATAL | `qFatal()` | 致命错误，程序将终止 |

## 各模块日志覆盖情况

### 1. APIService类 (网络请求和API调用)
- 网络请求开始和结束
- API调用参数和结果
- JSON解析状态
- 图片下载进度
- M3U8文件解析
- 错误处理和异常情况

### 2. DownloadEngine和DownloadTask类 (下载过程)
- 下载任务创建和启动
- 下载进度实时更新
- 文件写入状态
- 网络错误处理
- 任务取消和完成

### 3. ConcatWorker和TSMerger类 (视频拼接)
- TS文件扫描和排序
- 文件合并进度
- PMT包识别
- 无效包处理
- 合并结果状态

### 4. DecryptWorker类 (视频解密)
- 文件重命名和转换
- CBOX进程启动和执行
- 解密结果验证
- 临时文件清理
- 最终文件重命名

### 5. CCTVVideoDownloader类 (UI操作)
- 节目列表刷新
- 视频列表加载
- 用户选择操作
- 对话框打开和关闭
- 下载流程跟踪

### 6. Config类 (配置管理)
- 配置文件初始化
- 配置项读取
- 默认值设置
- 配置验证

## 日志消息格式示例

```
[2025-11-19 10:30:45.123] [DEBUG] 发送网络请求: https://api.cntv.cn/...
[2025-11-19 10:30:46.234] [INFO] 网络请求成功，响应数据大小: 2048 字节
[2025-11-19 10:30:47.345] [WARNING] 获取真实专辑ID失败: 响应数据为空
[2025-11-19 10:30:48.456] [CRITICAL] 无法打开输出文件: C:\Video\result.mp4
```

## 使用建议

### 1. 调试时
- 使用 `qDebug()` 输出详细的流程信息
- 包含关键参数和状态信息
- 记录重要决策点

### 2. 生产环境
- 使用 `qWarning()` 记录需要关注的问题
- 使用 `qCritical()` 记录严重错误
- 避免过多的DEBUG级别日志

### 3. 性能考虑
- 避免在循环中输出大量日志
- 使用条件编译控制调试日志
- 重要操作必须记录成功/失败状态

## 日志分析技巧

1. **时间线分析**: 通过时间戳跟踪操作序列
2. **错误追踪**: 使用WARNING和CRITICAL级别快速定位问题
3. **性能监控**: 通过操作耗时分析性能瓶颈
4. **用户行为**: 通过UI操作日志了解用户使用模式

## 常见问题排查

### 网络问题
- 查看APIService类的网络请求日志
- 检查响应数据大小和错误信息

### 下载失败
- 查看DownloadEngine的下载进度和错误信息
- 检查文件写入权限和磁盘空间

### 视频处理问题
- 查看ConcatWorker的TS文件处理日志
- 检查DecryptWorker的解密过程日志

### 配置问题
- 查看Config类的配置读取日志
- 验证配置项的值是否正确

## 注意事项

1. 日志文件会自动轮转，但建议定期清理旧日志
2. 敏感信息（如密码）不应记录在日志中
3. 生产环境建议调整日志级别以减少磁盘IO
4. 重大功能变更时应更新相应的日志输出

---

**最后更新**: 2025-11-19
**版本**: 1.0